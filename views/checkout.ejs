<!-- views/cart.ejs -->
<%- include('_layouts/header') %>

<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="/css/cart.css" />

<% if (Array.isArray(cart) && cart.length) { %>
  <div class="container mt-4">
    <h1 class="text-center mb-4">ðŸ›’ My Cart</h1>

    <table class="table table-striped text-center align-middle">
      <thead class="table-dark">
        <tr>
          <th>Title</th>
          <th>Price</th>
          <th>Quantity</th>
          <th>Actions</th>
          <th>Subtotal</th>
        </tr>
      </thead>
      <tbody>
        <% let total = 0; %>
        <% cart.forEach(product => { %>
          <% const sub = (product.qt * product.price).toFixed(2); %>
          <% total += Number(sub); %>
          <tr>
            <td data-label="Title"><%= product.title %></td>
            <td data-label="Price">â‚¹ <%= Number(product.price).toFixed(2) %></td>
            <td data-label="Quantity"><%= product.qt %></td>
            <td data-label="Actions">
              <a class="btn btn-sm btn-outline-primary" href="/cart/update/<%= encodeURIComponent(product.title) %>?action=add">+</a>
              <a class="btn btn-sm btn-outline-secondary" href="/cart/update/<%= encodeURIComponent(product.title) %>?action=remove">âˆ’</a>
              <a class="btn btn-sm btn-outline-danger" href="/cart/update/<%= encodeURIComponent(product.title) %>?action=clear">Clear</a>
            </td>
            <td data-label="Subtotal">â‚¹ <%= sub %></td>
          </tr>
        <% }) %>

        <tr class="fw-bold">
          <td colspan="4" class="text-end">Total:</td>
          <td>â‚¹ <%= total.toFixed(2) %></td>
        </tr>

        <tr>
          <td colspan="5" class="text-end">
            <a class="btn btn-danger me-2 clearcart" href="/cart/clear">Clear Cart</a>
            <button id="payBtn" class="btn btn-success"
                    data-total="<%= total.toFixed(2) %>">Buy Now</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    document.getElementById('payBtn').addEventListener('click', async function (e) {
      e.preventDefault();
      const totalAmount = parseFloat(this.dataset.total);       // INR
      if (!totalAmount) return alert('Cart total is invalid.');

      try {
        const res = await fetch('/payment/create-order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: totalAmount * 100 })    // Paisa
        });
        const order = await res.json();

        const options = {
          key: '<%- process.env.RAZORPAY_KEY_ID %>',
          amount: order.amount,
          currency: order.currency,
          name: 'Monsoon Gruhudyog',
          description: 'Purchase Order',
          order_id: order.id,
          handler: async function (response) {
            const verify = await fetch('/payment/verify-payment', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(response)
            });
            const msg = await verify.text();
            alert(msg);
            if (msg.includes('Verified')) window.location.href = '/cart/clear';
          }
        };

        new Razorpay(options).open();
      } catch (err) {
        console.error(err);
        alert('Payment failed to initialize.');
      }
    });
  </script>
<% } else { %>
  <div class="container text-center mt-5">
    <h3>Your cart is empty</h3>
    <a class="btn btn-outline-primary mt-3" href="/products">Browse Products</a>
  </div>
<% } %>

<%- include('_layouts/footer') %>
